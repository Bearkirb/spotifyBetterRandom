<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Liked Songs Randomizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #121212;
      color: white;
      padding-top: 50px;
    }
    button {
      background-color: #1DB954;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      margin: 10px;
    }
    button:hover { opacity: 0.9; }
    #status { margin-top: 30px; }
    a { color: #1DB954; }
  </style>
</head>
<body>

<h1>Bear Ultra Super Randomizer</h1>

<button onclick="login()">Login with Spotify</button>
<button onclick="createRandomPlaylist()">Create Random Playlist</button>

<div id="status"></div>

<script>

const clientId = "d08d293d8be24256bf6e6384fde0a7da";
const redirectUri = "https://bearkirb.github.io/spotifyBetterRandom/";
const scopes = "user-library-read playlist-modify-private playlist-modify-public";

// PKCE helpers
function generateRandomString(length) {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(length)))
    .map(x => possible[x % possible.length])
    .join('');
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return window.crypto.subtle.digest('SHA-256', data);
}

function base64urlencode(a) {
  return btoa(String.fromCharCode(...new Uint8Array(a)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}

async function login() {
  const codeVerifier = generateRandomString(64);
  localStorage.setItem("code_verifier", codeVerifier);

  const hashed = await sha256(codeVerifier);
  const codeChallenge = base64urlencode(hashed);

  const authUrl =
  "https://accounts.spotify.com/authorize?" +
  new URLSearchParams({
    client_id: clientId,
    response_type: "code",
    redirect_uri: redirectUri,
    code_challenge_method: "S256",
    code_challenge: codeChallenge,
    scope: scopes,
    show_dialog: "true"
  });


  window.location = authUrl;
}

async function getAccessToken() {

  // 1️⃣ If we already stored a token, use it
  const storedToken = localStorage.getItem("access_token");
  if (storedToken) return storedToken;

  // 2️⃣ Otherwise check for code in URL
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (!code) return null;

  const codeVerifier = localStorage.getItem("code_verifier");

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier
  });

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body
  });

  const data = await response.json();

  // 3️⃣ Store token for reuse
  localStorage.setItem("access_token", data.access_token);

  // 4️⃣ Clean URL (remove ?code=...)
  window.history.replaceState({}, document.title, redirectUri);

  return data.access_token;
}

async function createRandomPlaylist() {

  const token = await getAccessToken();
  fetch("https://api.spotify.com/v1/me", {
  headers: { Authorization: "Bearer " + token }
})
  if (!token) {
    alert("Please log in first.");
    return;
  }

  const status = document.getElementById("status");
  status.innerHTML = "Fetching liked songs...";

  // Get user
  const userRes = await fetch("https://api.spotify.com/v1/me", {
  headers: { Authorization: "Bearer " + token }
});

if (!userRes.ok) {
  const errorText = await userRes.text();
  console.log("Status:", userRes.status);
  console.log("Error response:", errorText);
  return;
}

const userData = await userRes.json();
console.log("Logged in as:", userData.email, userData.id);

  // Fetch ALL liked songs
 let allTracks = [];
let offset = 0;
const limit = 50;
let total = 0;

while (true) {

  const res = await fetch(
    `https://api.spotify.com/v1/me/tracks?limit=${limit}&offset=${offset}`,
    { headers: { Authorization: "Bearer " + token } }
  );

  if (!res.ok) {
    const errorText = await res.text();
    console.error("Liked songs fetch failed:", errorText);
    break;
  }

  const data = await res.json();

  console.log("Batch received:", data.items.length);

  allTracks = allTracks.concat(data.items);

  if (!data.next) break; // stop when no more pages

  offset += limit;
}

console.log("Total tracks collected:", allTracks.length);

  let trackUris = allTracks.map(item => item.track.uri);

  // Shuffle
  for (let i = trackUris.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [trackUris[i], trackUris[j]] = [trackUris[j], trackUris[i]];
  }

  status.innerHTML = "Creating playlist...";

const playlistRes = await fetch(
  `https://api.spotify.com/v1/me/playlists`,
  {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      name: "Randomized Liked Songs",
      description: `Shuffled ${trackUris.length} liked songs`,
      public: false
    })
  }
);

if (!playlistRes.ok) {
  const errorText = await playlistRes.text();
  console.error("Playlist creation failed:", errorText);
  throw new Error("Playlist creation failed");
}

const playlistData = await playlistRes.json();
console.log("Playlist created:", playlistData);



  // Add tracks in batches of 100
 for (let i = 0; i < trackUris.length; i += 100) {

  const batch = trackUris.slice(i, i + 100);

  const addRes = await fetch(
    `https://api.spotify.com/v1/playlists/${playlistData.id}/tracks`,
    {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        uris: batch
      })
    }
  );

  if (!addRes.ok) {
    const errorText = await addRes.text();
    console.error("Add tracks failed:", errorText);
    break;
  }

  console.log("Added batch:", batch.length);
}

  status.innerHTML = `
    ✅ Playlist created!<br><br>
    <a href="${playlistData.external_urls.spotify}" target="_blank">
      Open in Spotify
    </a>
  `;
}

</script>

</body>
</html>
